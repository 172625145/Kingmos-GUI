#include <eversion.h>
#include <windows.h>
#include <eoemkey.h>
#include "resource.h"
#include "windebug.h"
#include "w32cfg.h"
#include "cpu.h"

HWND hwndDeskTop = 0;
#define ID_OPTION_KEY_DOWN (12345)


typedef struct _OPTIONKEY
{
	RECT rc;
	BYTE bVirtualKey;
	BYTE bScanCode;
	BYTE bDown;
	BYTE bDumy1;
}OPTIONKEY;
//0X06;//=VK_POWEROFF;
//#define VK_POWEROFF         0X06
//#define VK_MEDIA_NEXT_TRACK              0xB0
//#define VK_MEDIA_PREV_TRACK              0xB1
//#define VK_MEDIA_STOP                    0xB2
//#define VK_MEDIA_PLAY_PAUSE              0xB3
OPTIONKEY rcOptionKey[] = 
{
	{ { 14, 140, (14+70), (140+40) }, VK_LMENU, 0, 0, 0 },// menu menu key
	{ { 14, 236, (14+70), (236+40) }, VK_INFO, 0, 0, 0 },// info menu key
	{ { 14, 324, (14+70), (324+40) }, VK_DELETE, 0, 0, 0 },// delete menu key

	{ { 755, 81, (755+70), (81+40) }, VK_ZOOM_INC, 0, 0, 0 },// zoom+ menu key
	{ { 755, 135, (755+70), (135+40) }, VK_ZOOM_DEC, 0, 0, 0 },// zoom- menu key
	{ { 755, 329, (755+70), (329+40) }, VK_PRINT, 0, 0, 0 },// print key
	{ { 755, 383, (755+70), (383+40) }, VK_CANCEL, 0, 0, 0 },// cancel menu key
	{ { 755, 434, (755+70), (434+40) }, VK_POWER, 0, 0, 0 },// print key
	{ { 755, 488, (755+70), (488+40) }, VK_BACKUP, 0, 0, 0 },// cancel menu key


	{ { 771, 236, (771+35), (236+35) }, VK_SET, 0, 0, 0 }, //enter key
	{ { 775, 272, (775+28), (272+22) }, VK_DOWN, 0, 0, 0 },//down key
	{ { 775, 211, (775+28), (211+22) }, VK_UP, 0, 0, 0 },//up key
	{ { 747, 240, (747+17), (240+25) }, VK_LEFT, 0, 0, 0 }, //left key
	{ { 810, 240, (810+17), (240+25) }, VK_RIGHT, 0, 0, 0 },//right key

};


#ifdef COLOR_1BPP
#define PALETTE_SIZE 2
#endif

#ifdef COLOR_4BPP
#define PALETTE_SIZE 16
#endif

#ifdef COLOR_8BPP
#define PALETTE_SIZE 256
#endif

#ifdef COLOR_16BPP
//#define PALETTE_SIZE 1
#endif

struct MY_BITMAPINFO {
    BITMAPINFOHEADER bmiHeader; 
#ifdef COLOR_16BPP
    DWORD mask[3];
#else
    RGBQUAD          bmiColors[PALETTE_SIZE];
#endif 
} myBitmapInfo= {
 {
    sizeof(BITMAPINFOHEADER),// DWORD  biSize; 
    DISPLAY_WIDTH,//LONG   biWidth; 
    -DISPLAY_HEIGHT,//LONG   biHeight; 
    1,//WORD   biPlanes; 
    BPP,//WORD   biBitCount 
#ifdef COLOR_16BPP
    BI_BITFIELDS,
#else
    BI_RGB,//DWORD  biCompression; 
#endif
    0,//DWORD  biSizeImage; 
    0,//LONG   biXPelsPerMeter; 
    0,//LONG   biYPelsPerMeter; 
#ifdef COLOR_16BPP
    3,//DWORD  biClrUsed; 
#else
    0,
#endif
    0  //DWORD  biClrImportant;     
 },
#ifdef COLOR_16BPP
 {  
    0x0000f800,   // red mask 5	
    0x000007e0,  // green mask 6    
    0x0000001f, // blue mask 5	
	}
#endif
#ifdef COLOR_1BPP
 {
     { 0x00, 0x00, 0x00, 0 },
     { 0xff, 0xff, 0, 0 }
 }
#endif

#ifdef COLOR_4BPP
 {
    { 0x00, 0x00, 0x00, 0 },  // 0 black
    { 0x11, 0x11, 0x11, 0 },  // 1 dark gray
    { 0x22, 0x22, 0x22, 0 },  // 2 gray
    { 0x33, 0x33, 0x33, 0 },   // 3 black

    { 0x44, 0x44, 0x44, 0 },  // 0 black
    { 0x55, 0x55, 0x55, 0 },  // 1 dark gray
    { 0x66, 0x66, 0x66, 0 },  // 2 gray
    { 0x77, 0x77, 0x77, 0 },   // 3 black

    { 0x88, 0x88, 0x88, 0 },  // 0 black
    { 0x99, 0x99, 0x99, 0 },  // 1 dark gray
    { 0xaa, 0xaa, 0xaa, 0 },  // 2 gray
    { 0xbb, 0xbb, 0xbb, 0 },   // 3 black

    { 0xcc, 0xcc, 0xcc, 0 },  // 0 black
    { 0xdd, 0xdd, 0xdd, 0 },  // 1 dark gray
    { 0xee, 0xee, 0xee, 0 },  // 2 gray
    { 0xff, 0xff, 0xff, 0 }   // 3 black
 }
#endif


#ifdef COLOR_8BPP
 {
    { 0x00, 0x00, 0x00, 0 },    /* 0 Sys Black      gray 0  */     		\
    { 0x80, 0x00, 0x00, 0 },    /* 1 Sys Dk Red  */                		\
    { 0x00, 0x80, 0x00, 0 },    /* 2 Sys Dk Green  */              		\
    { 0x80, 0x80, 0x00, 0 },    /* 3 Sys Dk Yellow  */             		\
    { 0x00, 0x00, 0x80, 0 },    /* 4 Sys Dk Blue  */               		\
    { 0x80, 0x00, 0x80, 0 },    /* 5 Sys Dk Violet  */             		\
    { 0x00, 0x80, 0x80, 0 },    /* 6 Sys Dk Cyan  */               		\
    { 0xc0, 0xc0, 0xc0, 0 },    /* 7 Sys Lt Grey    gray 192  */   		\
    { 0xc0, 0xdc, 0xc0, 0 },    /* 8 Sys 8  */                     		\
    { 0xa6, 0xca, 0xf0, 0 },    /* 9 Sys 9 (1st 10 fixed by Windows) */ \
    { 0x04, 0x04, 0x04, 0 },    /* 10       gray 4  */                  \
    { 0x08, 0x08, 0x08, 0 },    /* 11       gray 8  */                  \
    { 0x0c, 0x0c, 0x0c, 0 },    /* 12       gray 12  */                 \
    { 0x11, 0x11, 0x11, 0 },    /* 13       gray 17  */                 \
    { 0x16, 0x16, 0x16, 0 },    /* 14       gray 22  */                 \
    { 0x1c, 0x1c, 0x1c, 0 },    /* 15       gray 28  */                 \
    { 0x22, 0x22, 0x22, 0 },    /* 16       gray 34  */                 \
    { 0x29, 0x29, 0x29, 0 },    /* 17       gray 41  */                 \
    { 0x55, 0x55, 0x55, 0 },    /* 18 swap for good inversion gray 85 */\
    { 0x4d, 0x4d, 0x4d, 0 },    /* 19 swap for good inversion gray 77 */\
    { 0x42, 0x42, 0x42, 0 },    /* 20 swap for good inversion gray 66 */\
    { 0x39, 0x39, 0x39, 0 },    /* 21 swap for good inversion gray 57 */\
    { 0xFF, 0x7C, 0x80, 0 },    /* 22 R255 G124 B128  */                \
    { 0xFF, 0x50, 0x50, 0 },    /* 23 R255 G80  B80  */                 \
    { 0xD6, 0x00, 0x93, 0 },    /* 24 R214 G0   B147  */                \
    { 0xCC, 0xEC, 0xFF, 0 },    /* 25 R204 G236 B255  */                \
    { 0xEF, 0xD6, 0xC6, 0 },    /* 26 R239 G214 B198  */                \
    { 0xE7, 0xE7, 0xD6, 0 },    /* 27 R231 G231 B214  */                \
    { 0xAD, 0xA9, 0x90, 0 },    /* 28 R173 G169 B144  */                \
    { 0x33, 0x00, 0x00, 0 },    /* 29  */                               \
    { 0x66, 0x00, 0x00, 0 },    /* 30  */                               \
    { 0x99, 0x00, 0x00, 0 },    /* 31  */                               \
    { 0xcc, 0x00, 0x00, 0 },    /* 32  */                               \
    { 0x00, 0x33, 0x00, 0 },    /* 33  */                               \
    { 0x33, 0x33, 0x00, 0 },    /* 34  */                               \
    { 0x66, 0x33, 0x00, 0 },    /* 35  */                               \
    { 0x99, 0x33, 0x00, 0 },    /* 36  */                               \
    { 0xcc, 0x33, 0x00, 0 },    /* 37  */                               \
    { 0xff, 0x33, 0x00, 0 },    /* 38  */                               \
    { 0x00, 0x66, 0x00, 0 },    /* 39  */                               \
    { 0x33, 0x66, 0x00, 0 },    /* 40  */                               \
    { 0x66, 0x66, 0x00, 0 },    /* 41  */                               \
    { 0x99, 0x66, 0x00, 0 },    /* 42  */                               \
    { 0xcc, 0x66, 0x00, 0 },    /* 43  */                               \
    { 0xff, 0x66, 0x00, 0 },    /* 44  */                               \
    { 0x00, 0x99, 0x00, 0 },    /* 45  */                               \
    { 0x33, 0x99, 0x00, 0 },    /* 46  */                               \
    { 0x66, 0x99, 0x00, 0 },    /* 47  */                               \
    { 0x99, 0x99, 0x00, 0 },    /* 48  */                               \
    { 0xcc, 0x99, 0x00, 0 },    /* 49  */                               \
    { 0xff, 0x99, 0x00, 0 },    /* 50  */                               \
    { 0x00, 0xcc, 0x00, 0 },    /* 51  */                               \
    { 0x33, 0xcc, 0x00, 0 },    /* 52  */                               \
    { 0x66, 0xcc, 0x00, 0 },    /* 53  */                               \
    { 0x99, 0xcc, 0x00, 0 },    /* 54  */                               \
    { 0xcc, 0xcc, 0x00, 0 },    /* 55  */                               \
    { 0xff, 0xcc, 0x00, 0 },    /* 56  */                               \
    { 0x66, 0xff, 0x00, 0 },    /* 57  */                               \
    { 0x99, 0xff, 0x00, 0 },    /* 58  */                               \
    { 0xcc, 0xff, 0x00, 0 },    /* 59  */                               \
    { 0x00, 0x00, 0x33, 0 },    /* 60  */                               \
    { 0x33, 0x00, 0x33, 0 },    /* 61  */                               \
    { 0x66, 0x00, 0x33, 0 },    /* 62  */                               \
    { 0x99, 0x00, 0x33, 0 },    /* 63  */                               \
    { 0xcc, 0x00, 0x33, 0 },    /* 64  */                               \
    { 0xff, 0x00, 0x33, 0 },    /* 65  */                               \
    { 0x00, 0x33, 0x33, 0 },    /* 66  */                               \
    { 0x33, 0x33, 0x33, 0 },    /* 67 gray 51  */  		                \
    { 0x66, 0x33, 0x33, 0 },    /* 68  */                               \
    { 0x99, 0x33, 0x33, 0 },    /* 69  */                               \
    { 0xcc, 0x33, 0x33, 0 },    /* 70  */                               \
    { 0xff, 0x33, 0x33, 0 },    /* 71  */                               \
    { 0x00, 0x66, 0x33, 0 },    /* 72  */                               \
    { 0x33, 0x66, 0x33, 0 },    /* 73  */                               \
    { 0x66, 0x66, 0x33, 0 },    /* 74  */                               \
    { 0x99, 0x66, 0x33, 0 },    /* 75  */                               \
    { 0xcc, 0x66, 0x33, 0 },    /* 76  */                               \
    { 0xff, 0x66, 0x33, 0 },    /* 77  */                               \
    { 0x00, 0x99, 0x33, 0 },    /* 78  */                               \
    { 0x33, 0x99, 0x33, 0 },    /* 79  */                               \
    { 0x66, 0x99, 0x33, 0 },    /* 80  */                               \
    { 0x99, 0x99, 0x33, 0 },    /* 81  */                               \
    { 0xcc, 0x99, 0x33, 0 },    /* 82  */                               \
    { 0xff, 0x99, 0x33, 0 },    /* 83  */                               \
    { 0x00, 0xcc, 0x33, 0 },    /* 84  */                               \
    { 0x33, 0xcc, 0x33, 0 },    /* 85  */                               \
    { 0x66, 0xcc, 0x33, 0 },    /* 86  */                               \
    { 0x99, 0xcc, 0x33, 0 },    /* 87  */                               \
    { 0xcc, 0xcc, 0x33, 0 },    /* 88  */                               \
    { 0xff, 0xcc, 0x33, 0 },    /* 89  */                               \
    { 0x33, 0xff, 0x33, 0 },    /* 90  */                               \
    { 0x66, 0xff, 0x33, 0 },    /* 91  */                               \
    { 0x99, 0xff, 0x33, 0 },    /* 92  */                               \
    { 0xcc, 0xff, 0x33, 0 },    /* 93  */                               \
    { 0xff, 0xff, 0x33, 0 },    /* 94  */                               \
    { 0x00, 0x00, 0x66, 0 },    /* 95  */                               \
    { 0x33, 0x00, 0x66, 0 },    /* 96  */                               \
    { 0x66, 0x00, 0x66, 0 },    /* 97  */                               \
    { 0x99, 0x00, 0x66, 0 },    /* 98  */                               \
    { 0xcc, 0x00, 0x66, 0 },    /* 99  */                               \
    { 0xff, 0x00, 0x66, 0 },    /* 100 */                               \
    { 0x00, 0x33, 0x66, 0 },    /* 101 */                               \
    { 0x33, 0x33, 0x66, 0 },    /* 102 */                               \
    { 0x66, 0x33, 0x66, 0 },    /* 103 */                               \
    { 0x99, 0x33, 0x66, 0 },    /* 104 */                               \
    { 0xcc, 0x33, 0x66, 0 },    /* 105 */                               \
    { 0xff, 0x33, 0x66, 0 },    /* 106 */                               \
    { 0x00, 0x66, 0x66, 0 },    /* 107 */                               \
    { 0x33, 0x66, 0x66, 0 },    /* 108 */                               \
    { 0x66, 0x66, 0x66, 0 },    /* 109 gray 102  */                		\
    { 0x99, 0x66, 0x66, 0 },    /* 110 */                              	\
    { 0xcc, 0x66, 0x66, 0 },    /* 111 */                              	\
    { 0x00, 0x99, 0x66, 0 },    /* 112 */                              	\
    { 0x33, 0x99, 0x66, 0 },    /* 113 */                              	\
    { 0x66, 0x99, 0x66, 0 },    /* 114 */                              	\
    { 0x99, 0x99, 0x66, 0 },    /* 115 */                              	\
    { 0xcc, 0x99, 0x66, 0 },    /* 116 */                              	\
    { 0xff, 0x99, 0x66, 0 },    /* 117 */                              	\
    { 0x00, 0xcc, 0x66, 0 },    /* 118 */                              	\
    { 0x33, 0xcc, 0x66, 0 },    /* 119 */                              	\
    { 0x99, 0xcc, 0x66, 0 },    /* 120 */                              	\
    { 0xcc, 0xcc, 0x66, 0 },    /* 121 */                              	\
    { 0xff, 0xcc, 0x66, 0 },    /* 122 */                              	\
    { 0x00, 0xff, 0x66, 0 },    /* 123 */                              	\
    { 0x33, 0xff, 0x66, 0 },    /* 124 */                              	\
    { 0x99, 0xff, 0x66, 0 },    /* 125 */                              	\
    { 0xcc, 0xff, 0x66, 0 },    /* 126 */                              	\
    { 0xff, 0x00, 0xcc, 0 },    /* 127 */                              	\
    { 0xcc, 0x00, 0xff, 0 },    /* 128 */                              	\
    { 0x00, 0x99, 0x99, 0 },    /* 129 */                              	\
    { 0x99, 0x33, 0x99, 0 },    /* 130 */                              	\
    { 0x99, 0x00, 0x99, 0 },    /* 131 */                              	\
    { 0xcc, 0x00, 0x99, 0 },    /* 132 */                              	\
    { 0x00, 0x00, 0x99, 0 },    /* 133 */                              	\
    { 0x33, 0x33, 0x99, 0 },    /* 134 */                              	\
    { 0x66, 0x00, 0x99, 0 },    /* 135 */                              	\
    { 0xcc, 0x33, 0x99, 0 },    /* 136 */                              	\
    { 0xff, 0x00, 0x99, 0 },    /* 137 */                              	\
    { 0x00, 0x66, 0x99, 0 },    /* 138 */                              	\
    { 0x33, 0x66, 0x99, 0 },    /* 139 */                              	\
    { 0x66, 0x33, 0x99, 0 },    /* 140 */                              	\
    { 0x99, 0x66, 0x99, 0 },    /* 141 */                              	\
    { 0xcc, 0x66, 0x99, 0 },    /* 142 */                              	\
    { 0xff, 0x33, 0x99, 0 },    /* 143 */                              	\
    { 0x33, 0x99, 0x99, 0 },    /* 144 */                              	\
    { 0x66, 0x99, 0x99, 0 },    /* 145 */                              	\
    { 0x99, 0x99, 0x99, 0 },    /* 146 gray 153  */                     \
    { 0xcc, 0x99, 0x99, 0 },    /* 147 */                              \
    { 0xff, 0x99, 0x99, 0 },    /* 148 */                              \
    { 0x00, 0xcc, 0x99, 0 },    /* 149 */                              \
    { 0x33, 0xcc, 0x99, 0 },    /* 150 */                              \
    { 0x66, 0xcc, 0x66, 0 },    /* 151 */                              \
    { 0x99, 0xcc, 0x99, 0 },    /* 152 */                              \
    { 0xcc, 0xcc, 0x99, 0 },    /* 153 */                              \
    { 0xff, 0xcc, 0x99, 0 },    /* 154 */                              \
    { 0x00, 0xff, 0x99, 0 },    /* 155 */                              \
    { 0x33, 0xff, 0x99, 0 },    /* 156 */                              \
    { 0x66, 0xcc, 0x99, 0 },    /* 157 */                              \
    { 0x99, 0xff, 0x99, 0 },    /* 158 */                              \
    { 0xcc, 0xff, 0x99, 0 },    /* 159 */                              \
    { 0xff, 0xff, 0x99, 0 },    /* 160 */                              \
    { 0x00, 0x00, 0xcc, 0 },    /* 161 */                              \
    { 0x33, 0x00, 0x99, 0 },    /* 162 */                              \
    { 0x66, 0x00, 0xcc, 0 },    /* 163 */                              \
    { 0x99, 0x00, 0xcc, 0 },    /* 164 */                              \
    { 0xcc, 0x00, 0xcc, 0 },    /* 165 */                              \
    { 0x00, 0x33, 0x99, 0 },    /* 166 */                              \
    { 0x33, 0x33, 0xcc, 0 },    /* 167 */                              \
    { 0x66, 0x33, 0xcc, 0 },    /* 168 */                              \
    { 0x99, 0x33, 0xcc, 0 },    /* 169 */                              \
    { 0xcc, 0x33, 0xcc, 0 },    /* 170 */                              \
    { 0xff, 0x33, 0xcc, 0 },    /* 171 */                              \
    { 0x00, 0x66, 0xcc, 0 },    /* 172 */                              \
    { 0x33, 0x66, 0xcc, 0 },    /* 173 */                              \
    { 0x66, 0x66, 0x99, 0 },    /* 174 */                              \
    { 0x99, 0x66, 0xcc, 0 },    /* 175 */                              \
    { 0xcc, 0x66, 0xcc, 0 },    /* 176 */                              \
    { 0xff, 0x66, 0x99, 0 },    /* 177 */                              \
    { 0x00, 0x99, 0xcc, 0 },    /* 178 */                              \
    { 0x33, 0x99, 0xcc, 0 },    /* 179 */                              \
    { 0x66, 0x99, 0xcc, 0 },    /* 180 */                              \
    { 0x99, 0x99, 0xcc, 0 },    /* 181 */                              \
    { 0xcc, 0x99, 0xcc, 0 },    /* 182 */                              \
    { 0xff, 0x99, 0xcc, 0 },    /* 183 */                              \
    { 0x00, 0xcc, 0xcc, 0 },    /* 184 */                              \
    { 0x33, 0xcc, 0xcc, 0 },    /* 185 */                              \
    { 0x66, 0xcc, 0xcc, 0 },    /* 186 */                              \
    { 0x99, 0xcc, 0xcc, 0 },    /* 187 */                              \
    { 0xcc, 0xcc, 0xcc, 0 },    /* 188 gray 204 */                     \
    { 0xff, 0xcc, 0xcc, 0 },    /* 189 */                              \
    { 0x00, 0xff, 0xcc, 0 },    /* 190 */                              \
    { 0x33, 0xff, 0xcc, 0 },    /* 191 */                              \
    { 0x66, 0xff, 0x99, 0 },    /* 192 */                              \
    { 0x99, 0xff, 0xcc, 0 },    /* 193 */                              \
    { 0xcc, 0xff, 0xcc, 0 },    /* 194 */                              \
    { 0xff, 0xff, 0xcc, 0 },    /* 195 */                              \
    { 0x33, 0x00, 0xcc, 0 },    /* 196 */                              \
    { 0x66, 0x00, 0xff, 0 },    /* 197 */                              \
    { 0x99, 0x00, 0xff, 0 },    /* 198 */                              \
    { 0x00, 0x33, 0xcc, 0 },    /* 199 */                              \
    { 0x33, 0x33, 0xff, 0 },    /* 200 */                              \
    { 0x66, 0x33, 0xff, 0 },    /* 201 */                              \
    { 0x99, 0x33, 0xff, 0 },    /* 202 */                              \
    { 0xcc, 0x33, 0xff, 0 },    /* 203 */                              \
    { 0xff, 0x33, 0xff, 0 },    /* 204 */                              \
    { 0x00, 0x66, 0xff, 0 },    /* 205 */                              \
    { 0x33, 0x66, 0xff, 0 },    /* 206 */                              \
    { 0x66, 0x66, 0xcc, 0 },    /* 207 */                              \
    { 0x99, 0x66, 0xff, 0 },    /* 208 */                              \
    { 0xcc, 0x66, 0xff, 0 },    /* 209 */                              \
    { 0xff, 0x66, 0xcc, 0 },    /* 210 */                              \
    { 0x00, 0x99, 0xff, 0 },    /* 211 */                              \
    { 0x33, 0x99, 0xff, 0 },    /* 212 */                              \
    { 0x66, 0x99, 0xff, 0 },    /* 213 */                              \
    { 0x99, 0x99, 0xff, 0 },    /* 214 */                              \
    { 0xcc, 0x99, 0xff, 0 },    /* 215 */                              \
    { 0xff, 0x99, 0xff, 0 },    /* 216 */                              \
    { 0x00, 0xcc, 0xff, 0 },    /* 217 */                              \
    { 0x33, 0xcc, 0xff, 0 },    /* 218 */                              \
    { 0x66, 0xcc, 0xff, 0 },    /* 219 */                              \
    { 0x99, 0xcc, 0xff, 0 },    /* 220 */                              \
    { 0xcc, 0xcc, 0xff, 0 },    /* 221 */                              \
    { 0xff, 0xcc, 0xff, 0 },    /* 222 */                              \
    { 0x33, 0xff, 0xff, 0 },    /* 223 */                              \
    { 0x66, 0xff, 0xcc, 0 },    /* 224 */                              \
    { 0x99, 0xff, 0xff, 0 },    /* 225 */                              \
    { 0xcc, 0xff, 0xff, 0 },    /* 226 */                              \
    { 0xff, 0x66, 0x66, 0 },    /* 227 */                              \
    { 0x66, 0xff, 0x66, 0 },    /* 228 */                              \
    { 0xff, 0xff, 0x66, 0 },    /* 229 */                              \
    { 0x66, 0x66, 0xff, 0 },    /* 230 */                              \
    { 0xff, 0x66, 0xff, 0 },    /* 231 */                              \
    { 0x66, 0xff, 0xff, 0 },    /* 232 */                              \
    { 0xA5, 0x00, 0x21, 0 },    /* 233 R165 G0 B33 */                  \
    { 0x5f, 0x5f, 0x5f, 0 },    /* 234 gray 95  */                     \
    { 0x77, 0x77, 0x77, 0 },    /* 235 gray 119 */                     \
    { 0x86, 0x86, 0x86, 0 },    /* 236 gray 134 */                     \
    { 0x96, 0x96, 0x96, 0 },    /* 237 gray 150 */                     \
    { 0xcb, 0xcb, 0xcb, 0 },    /* 238 gray 203 */                     \
    { 0xb2, 0xb2, 0xb2, 0 },    /* 239 gray 178 */                     \
    { 0xd7, 0xd7, 0xd7, 0 },    /* 240 gray 215 */                     \
    { 0xdd, 0xdd, 0xdd, 0 },    /* 241 gray 221 */                     \
    { 0xe3, 0xe3, 0xe3, 0 },    /* 242 gray 227 */                     \
    { 0xea, 0xea, 0xea, 0 },    /* 243 gray 234 */                     \
    { 0xf1, 0xf1, 0xf1, 0 },    /* 244 gray 241 */                     \
    { 0xf8, 0xf8, 0xf8, 0 },    /* 245 gray 248 */                     \
    { 0xff, 0xfb, 0xf0, 0 },    /* 246 Sys Reserved */                 \
    { 0xa0, 0xa0, 0xa4, 0 },    /* 247 Sys Reserved */                 \
    { 0x80, 0x80, 0x80, 0 },    /* 248 Sys Lt Gray  gray 128 */        \
    { 0xff, 0x00, 0x00, 0 },    /* 249 Sys Red */                      \
    { 0x00, 0xff, 0x00, 0 },    /* 250 Sys Green */                    \
    { 0xff, 0xff, 0x00, 0 },    /* 251 Sys Yellow */                   \
    { 0x00, 0x00, 0xff, 0 },    /* 252 Sys Blue */                     \
    { 0xff, 0x00, 0xff, 0 },    /* 253 Sys Violet */                   \
    { 0x00, 0xff, 0xff, 0 },    /* 254 Sys Cyan */                     \
    { 0xff, 0xff, 0xff, 0 }     /* 255 Sys White gray 255 */           \
	}
#endif

#if 0//def COLOR_8BPP
 {                                                                                       \
 	{ 0x00, 0x00, 0x00, 0 },    /* 0 Sys Black      gray 0  */                          \
    { 0x00, 0x00, 0x80, 0 },    /* 1 Sys Dk Red  */                                     \
    { 0x00, 0x80, 0x00, 0 },    /* 2 Sys Dk Green  */                                   \
    { 0x00, 0x80, 0x80, 0 },    /* 3 Sys Dk Yellow  */                                  \
    { 0x80, 0x00, 0x00, 0 },    /* 4 Sys Dk Blue  */                                    \
    { 0x80, 0x00, 0x80, 0 },    /* 5 Sys Dk Violet  */                                  \
    { 0x80, 0x80, 0x00, 0 },    /* 6 Sys Dk Cyan  */                                    \
    { 0xc0, 0xc0, 0xc0, 0 },    /* 7 Sys Lt Grey    gray 192  */                        \
    { 0xc0, 0xdc, 0xc0, 0 },    /* 8 Sys 8  */                                          \
    { 0xf0, 0xca, 0xa6, 0 },    /* 9 Sys 9 (the first 10 are fixed by Windows)  */      \
    { 0x04, 0x04, 0x04, 0 },    /* 10       gray 4  */                                  \
    { 0x08, 0x08, 0x08, 0 },    /* 11       gray 8  */                                  \
    { 0x0c, 0x0c, 0x0c, 0 },    /* 12       gray 12  */                                 \
    { 0x11, 0x11, 0x11, 0 },    /* 13       gray 17  */                                 \
    { 0x16, 0x16, 0x16, 0 },    /* 14       gray 22  */                                 \
    { 0x1c, 0x1c, 0x1c, 0 },    /* 15       gray 28  */                                 \
    { 0x22, 0x22, 0x22, 0 },    /* 16       gray 34  */                                 \
    { 0x29, 0x29, 0x29, 0 },    /* 17       gray 41  */                                 \
    { 0x55, 0x55, 0x55, 0 },    /* 18 swapped so inversions look good       gray 85  */ \
    { 0x4d, 0x4d, 0x4d, 0 },    /* 19 swapped so inversions look good       gray 77  */ \
    { 0x42, 0x42, 0x42, 0 },    /* 20 swapped so inversions look good       gray 66  */ \
    { 0x39, 0x39, 0x39, 0 },    /* 21 swapped so inversions look good       gray 57  */ \
    { 0xFF, 0x7C, 0x80, 0 },    /* 22 R255 G124 B128  */                                \
    { 0xFF, 0x50, 0x50, 0 },    /* 23 R255 G80  B80  */                                 \
    { 0xD6, 0x00, 0x93, 0 },    /* 24 R214 G0   B147  */                                \
    { 0xCC, 0xEC, 0xFF, 0 },    /* 25 R204 G236 B255  */                                \
    { 0xEF, 0xD6, 0xC6, 0 },    /* 26 R239 G214 B198  */                                \
    { 0xE7, 0xE7, 0xD6, 0 },    /* 27 R231 G231 B214  */                                \
    { 0xAD, 0xA9, 0x90, 0 },    /* 28 R173 G169 B144  */                                \
    { 0x33, 0x00, 0x00, 0 },    /* 29  */                                               \
    { 0x66, 0x00, 0x00, 0 },    /* 30  */                                               \
    { 0x99, 0x00, 0x00, 0 },    /* 31  */                                               \
    { 0xcc, 0x00, 0x00, 0 },    /* 32  */                                               \
    { 0x00, 0x33, 0x00, 0 },    /* 33  */                                               \
    { 0x33, 0x33, 0x00, 0 },    /* 34  */                                               \
    { 0x66, 0x33, 0x00, 0 },    /* 35  */                                               \
    { 0x99, 0x33, 0x00, 0 },    /* 36  */                                               \
    { 0xcc, 0x33, 0x00, 0 },    /* 37  */                                               \
    { 0xff, 0x33, 0x00, 0 },    /* 38  */                                               \
    { 0x00, 0x66, 0x00, 0 },    /* 39  */                                               \
    { 0x33, 0x66, 0x00, 0 },    /* 40  */                                               \
    { 0x66, 0x66, 0x00, 0 },    /* 41  */                                               \
    { 0x99, 0x66, 0x00, 0 },    /* 42  */                                               \
    { 0xcc, 0x66, 0x00, 0 },    /* 43  */                                               \
    { 0xff, 0x66, 0x00, 0 },    /* 44  */                                               \
    { 0x00, 0x99, 0x00, 0 },    /* 45  */                                               \
    { 0x33, 0x99, 0x00, 0 },    /* 46  */                                               \
    { 0x66, 0x99, 0x00, 0 },    /* 47  */                                               \
    { 0x99, 0x99, 0x00, 0 },    /* 48  */                                               \
    { 0xcc, 0x99, 0x00, 0 },    /* 49  */                                               \
    { 0xff, 0x99, 0x00, 0 },    /* 50  */                                               \
    { 0x00, 0xcc, 0x00, 0 },    /* 51  */                                               \
    { 0x33, 0xcc, 0x00, 0 },    /* 52  */                                               \
    { 0x66, 0xcc, 0x00, 0 },    /* 53  */                                               \
    { 0x99, 0xcc, 0x00, 0 },    /* 54  */                                               \
    { 0xcc, 0xcc, 0x00, 0 },    /* 55  */                                               \
    { 0xff, 0xcc, 0x00, 0 },    /* 56  */                                               \
    { 0x66, 0xff, 0x00, 0 },    /* 57  */                                               \
    { 0x99, 0xff, 0x00, 0 },    /* 58  */                                               \
    { 0xcc, 0xff, 0x00, 0 },    /* 59  */                                               \
    { 0x00, 0x00, 0x33, 0 },    /* 60  */                                               \
    { 0x33, 0x00, 0x33, 0 },    /* 61  */                                               \
    { 0x66, 0x00, 0x33, 0 },    /* 62  */                                               \
    { 0x99, 0x00, 0x33, 0 },    /* 63  */                                               \
    { 0xcc, 0x00, 0x33, 0 },    /* 64  */                                               \
    { 0xff, 0x00, 0x33, 0 },    /* 65  */                                               \
    { 0x00, 0x33, 0x33, 0 },    /* 66  */                                               \
    { 0x33, 0x33, 0x33, 0 },    /* 67       gray 51  */                                 \
    { 0x66, 0x33, 0x33, 0 },    /* 68  */                                               \
    { 0x99, 0x33, 0x33, 0 },    /* 69  */                                               \
    { 0xcc, 0x33, 0x33, 0 },    /* 70  */                                               \
    { 0xff, 0x33, 0x33, 0 },    /* 71  */                                               \
    { 0x00, 0x66, 0x33, 0 },    /* 72  */                                               \
    { 0x33, 0x66, 0x33, 0 },    /* 73  */                                               \
    { 0x66, 0x66, 0x33, 0 },    /* 74  */                                               \
    { 0x99, 0x66, 0x33, 0 },    /* 75  */                                               \
    { 0xcc, 0x66, 0x33, 0 },    /* 76  */                                               \
    { 0xff, 0x66, 0x33, 0 },    /* 77  */                                               \
    { 0x00, 0x99, 0x33, 0 },    /* 78  */                                               \
    { 0x33, 0x99, 0x33, 0 },    /* 79  */                                               \
    { 0x66, 0x99, 0x33, 0 },    /* 80  */                                               \
    { 0x99, 0x99, 0x33, 0 },    /* 81  */                                               \
    { 0xcc, 0x99, 0x33, 0 },    /* 82  */                                               \
    { 0xff, 0x99, 0x33, 0 },    /* 83  */                                               \
    { 0x00, 0xcc, 0x33, 0 },    /* 84  */                                               \
    { 0x33, 0xcc, 0x33, 0 },    /* 85  */                                               \
    { 0x66, 0xcc, 0x33, 0 },    /* 86  */                                               \
    { 0x99, 0xcc, 0x33, 0 },    /* 87  */                                               \
    { 0xcc, 0xcc, 0x33, 0 },    /* 88  */                                               \
    { 0xff, 0xcc, 0x33, 0 },    /* 89  */                                               \
    { 0x33, 0xff, 0x33, 0 },    /* 90  */                                               \
    { 0x66, 0xff, 0x33, 0 },    /* 91  */                                               \
    { 0x99, 0xff, 0x33, 0 },    /* 92  */                                               \
    { 0xcc, 0xff, 0x33, 0 },    /* 93  */                                               \
    { 0xff, 0xff, 0x33, 0 },    /* 94  */                                               \
    { 0x00, 0x00, 0x66, 0 },    /* 95  */                                               \
    { 0x33, 0x00, 0x66, 0 },    /* 96  */                                               \
    { 0x66, 0x00, 0x66, 0 },    /* 97  */                                               \
    { 0x99, 0x00, 0x66, 0 },    /* 98  */                                               \
    { 0xcc, 0x00, 0x66, 0 },    /* 99  */                                               \
    { 0xff, 0x00, 0x66, 0 },    /* 100  */                                              \
    { 0x00, 0x33, 0x66, 0 },    /* 101  */                                              \
    { 0x33, 0x33, 0x66, 0 },    /* 102  */                                              \
    { 0x66, 0x33, 0x66, 0 },    /* 103  */                                              \
    { 0x99, 0x33, 0x66, 0 },    /* 104  */                                              \
    { 0xcc, 0x33, 0x66, 0 },    /* 105  */                                              \
    { 0xff, 0x33, 0x66, 0 },    /* 106  */                                              \
    { 0x00, 0x66, 0x66, 0 },    /* 107  */                                              \
    { 0x33, 0x66, 0x66, 0 },    /* 108  */                                              \
    { 0x66, 0x66, 0x66, 0 },    /* 109      gray 102  */                                \
    { 0x99, 0x66, 0x66, 0 },    /* 110  */                                              \
    { 0xcc, 0x66, 0x66, 0 },    /* 111  */                                              \
    { 0x00, 0x99, 0x66, 0 },    /* 112  */                                              \
    { 0x33, 0x99, 0x66, 0 },    /* 113  */                                              \
    { 0x66, 0x99, 0x66, 0 },    /* 114  */                                              \
    { 0x99, 0x99, 0x66, 0 },    /* 115  */                                              \
    { 0xcc, 0x99, 0x66, 0 },    /* 116  */                                              \
    { 0xff, 0x99, 0x66, 0 },    /* 117  */                                              \
    { 0x00, 0xcc, 0x66, 0 },    /* 118  */                                              \
    { 0x33, 0xcc, 0x66, 0 },    /* 119  */                                              \
    { 0x99, 0xcc, 0x66, 0 },    /* 120  */                                              \
    { 0xcc, 0xcc, 0x66, 0 },    /* 121  */                                              \
    { 0xff, 0xcc, 0x66, 0 },    /* 122  */                                              \
    { 0x00, 0xff, 0x66, 0 },    /* 123  */                                              \
    { 0x33, 0xff, 0x66, 0 },    /* 124  */                                              \
    { 0x99, 0xff, 0x66, 0 },    /* 125  */                                              \
    { 0xcc, 0xff, 0x66, 0 },    /* 126  */                                              \
    { 0xff, 0x00, 0xcc, 0 },    /* 127  */                                              \
    { 0xcc, 0x00, 0xff, 0 },    /* 128  */                                              \
    { 0x00, 0x99, 0x99, 0 },    /* 129  */                                              \
    { 0x99, 0x33, 0x99, 0 },    /* 130  */                                              \
    { 0x99, 0x00, 0x99, 0 },    /* 131  */                                              \
    { 0xcc, 0x00, 0x99, 0 },    /* 132  */                                              \
    { 0x00, 0x00, 0x99, 0 },    /* 133  */                                              \
    { 0x33, 0x33, 0x99, 0 },    /* 134  */                                              \
    { 0x66, 0x00, 0x99, 0 },    /* 135  */                                              \
    { 0xcc, 0x33, 0x99, 0 },    /* 136  */                                              \
    { 0xff, 0x00, 0x99, 0 },    /* 137  */                                              \
    { 0x00, 0x66, 0x99, 0 },    /* 138  */                                              \
    { 0x33, 0x66, 0x99, 0 },    /* 139  */                                              \
    { 0x66, 0x33, 0x99, 0 },    /* 140  */                                              \
    { 0x99, 0x66, 0x99, 0 },    /* 141  */                                              \
    { 0xcc, 0x66, 0x99, 0 },    /* 142  */                                              \
    { 0xff, 0x33, 0x99, 0 },    /* 143  */                                              \
    { 0x33, 0x99, 0x99, 0 },    /* 144  */                                              \
    { 0x66, 0x99, 0x99, 0 },    /* 145  */                                              \
    { 0x99, 0x99, 0x99, 0 },    /* 146      gray 153  */                                \
    { 0xcc, 0x99, 0x99, 0 },    /* 147  */                                              \
    { 0xff, 0x99, 0x99, 0 },    /* 148  */                                              \
    { 0x00, 0xcc, 0x99, 0 },    /* 149  */                                              \
    { 0x33, 0xcc, 0x99, 0 },    /* 150  */                                              \
    { 0x66, 0xcc, 0x66, 0 },    /* 151  */                                              \
    { 0x99, 0xcc, 0x99, 0 },    /* 152  */                                              \
    { 0xcc, 0xcc, 0x99, 0 },    /* 153  */                                              \
    { 0xff, 0xcc, 0x99, 0 },    /* 154  */                                              \
    { 0x00, 0xff, 0x99, 0 },    /* 155  */                                              \
    { 0x33, 0xff, 0x99, 0 },    /* 156  */                                              \
    { 0x66, 0xcc, 0x99, 0 },    /* 157  */                                              \
    { 0x99, 0xff, 0x99, 0 },    /* 158  */                                              \
    { 0xcc, 0xff, 0x99, 0 },    /* 159  */                                              \
    { 0xff, 0xff, 0x99, 0 },    /* 160  */                                              \
    { 0x00, 0x00, 0xcc, 0 },    /* 161  */                                              \
    { 0x33, 0x00, 0x99, 0 },    /* 162  */                                              \
    { 0x66, 0x00, 0xcc, 0 },    /* 163  */                                              \
    { 0x99, 0x00, 0xcc, 0 },    /* 164  */                                              \
    { 0xcc, 0x00, 0xcc, 0 },    /* 165  */                                              \
    { 0x00, 0x33, 0x99, 0 },    /* 166  */                                              \
    { 0x33, 0x33, 0xcc, 0 },    /* 167  */                                              \
    { 0x66, 0x33, 0xcc, 0 },    /* 168  */                                              \
    { 0x99, 0x33, 0xcc, 0 },    /* 169  */                                              \
    { 0xcc, 0x33, 0xcc, 0 },    /* 170  */                                              \
    { 0xff, 0x33, 0xcc, 0 },    /* 171  */                                              \
    { 0x00, 0x66, 0xcc, 0 },    /* 172  */                                              \
    { 0x33, 0x66, 0xcc, 0 },    /* 173  */                                              \
    { 0x66, 0x66, 0x99, 0 },    /* 174  */                                              \
    { 0x99, 0x66, 0xcc, 0 },    /* 175  */                                              \
    { 0xcc, 0x66, 0xcc, 0 },    /* 176  */                                              \
    { 0xff, 0x66, 0x99, 0 },    /* 177  */                                              \
    { 0x00, 0x99, 0xcc, 0 },    /* 178  */                                              \
    { 0x33, 0x99, 0xcc, 0 },    /* 179  */                                              \
    { 0x66, 0x99, 0xcc, 0 },    /* 180  */                                              \
    { 0x99, 0x99, 0xcc, 0 },    /* 181  */                                              \
    { 0xcc, 0x99, 0xcc, 0 },    /* 182  */                                              \
    { 0xff, 0x99, 0xcc, 0 },    /* 183  */                                              \
    { 0x00, 0xcc, 0xcc, 0 },    /* 184  */                                              \
    { 0x33, 0xcc, 0xcc, 0 },    /* 185  */                                              \
    { 0x66, 0xcc, 0xcc, 0 },    /* 186  */                                              \
    { 0x99, 0xcc, 0xcc, 0 },    /* 187  */                                              \
    { 0xcc, 0xcc, 0xcc, 0 },    /* 188      gray 204  */                                \
    { 0xff, 0xcc, 0xcc, 0 },    /* 189  */                                              \
    { 0x00, 0xff, 0xcc, 0 },    /* 190  */                                              \
    { 0x33, 0xff, 0xcc, 0 },    /* 191  */                                              \
    { 0x66, 0xff, 0x99, 0 },    /* 192  */                                              \
    { 0x99, 0xff, 0xcc, 0 },    /* 193  */                                              \
    { 0xcc, 0xff, 0xcc, 0 },    /* 194  */                                              \
    { 0xff, 0xff, 0xcc, 0 },    /* 195  */                                              \
    { 0x33, 0x00, 0xcc, 0 },    /* 196  */                                              \
    { 0x66, 0x00, 0xff, 0 },    /* 197  */                                              \
    { 0x99, 0x00, 0xff, 0 },    /* 198  */                                              \
    { 0x00, 0x33, 0xcc, 0 },    /* 199  */                                              \
    { 0x33, 0x33, 0xff, 0 },    /* 200  */                                              \
    { 0x66, 0x33, 0xff, 0 },    /* 201  */                                              \
    { 0x99, 0x33, 0xff, 0 },    /* 202  */                                              \
    { 0xcc, 0x33, 0xff, 0 },    /* 203  */                                              \
    { 0xff, 0x33, 0xff, 0 },    /* 204  */                                              \
    { 0x00, 0x66, 0xff, 0 },    /* 205  */                                              \
    { 0x33, 0x66, 0xff, 0 },    /* 206  */                                              \
    { 0x66, 0x66, 0xcc, 0 },    /* 207  */                                              \
    { 0x99, 0x66, 0xff, 0 },    /* 208  */                                              \
    { 0xcc, 0x66, 0xff, 0 },    /* 209  */                                              \
    { 0xff, 0x66, 0xcc, 0 },    /* 210  */                                              \
    { 0x00, 0x99, 0xff, 0 },    /* 211  */                                              \
    { 0x33, 0x99, 0xff, 0 },    /* 212  */                                              \
    { 0x66, 0x99, 0xff, 0 },    /* 213  */                                              \
    { 0x99, 0x99, 0xff, 0 },    /* 214  */                                              \
    { 0xcc, 0x99, 0xff, 0 },    /* 215  */                                              \
    { 0xff, 0x99, 0xff, 0 },    /* 216  */                                              \
    { 0x00, 0xcc, 0xff, 0 },    /* 217  */                                              \
    { 0x33, 0xcc, 0xff, 0 },    /* 218  */                                              \
    { 0x66, 0xcc, 0xff, 0 },    /* 219  */                                              \
    { 0x99, 0xcc, 0xff, 0 },    /* 220  */                                              \
    { 0xcc, 0xcc, 0xff, 0 },    /* 221  */                                              \
    { 0xff, 0xcc, 0xff, 0 },    /* 222  */                                              \
    { 0x33, 0xff, 0xff, 0 },    /* 223  */                                              \
    { 0x66, 0xff, 0xcc, 0 },    /* 224  */                                              \
    { 0x99, 0xff, 0xff, 0 },    /* 225  */                                              \
    { 0xcc, 0xff, 0xff, 0 },    /* 226  */                                              \
    { 0xff, 0x66, 0x66, 0 },    /* 227  */                                              \
    { 0x66, 0xff, 0x66, 0 },    /* 228  */                                              \
    { 0xff, 0xff, 0x66, 0 },    /* 229  */                                              \
    { 0x66, 0x66, 0xff, 0 },    /* 230  */                                              \
    { 0xff, 0x66, 0xff, 0 },    /* 231  */                                              \
    { 0x66, 0xff, 0xff, 0 },    /* 232  */                                              \
    { 0xA5, 0x00, 0x21, 0 },    /* 233      R165 G0 B33  */                             \
    { 0x5f, 0x5f, 0x5f, 0 },    /* 234      gray 95  */                                 \
    { 0x77, 0x77, 0x77, 0 },    /* 235      gray 119  */                                \
    { 0x86, 0x86, 0x86, 0 },    /* 236      gray 134  */                                \
    { 0x96, 0x96, 0x96, 0 },    /* 237      gray 150  */                                \
    { 0xcb, 0xcb, 0xcb, 0 },    /* 238      gray 203  */                                \
    { 0xb2, 0xb2, 0xb2, 0 },    /* 239      gray 178  */                                \
    { 0xd7, 0xd7, 0xd7, 0 },    /* 240      gray 215  */                                \
    { 0xdd, 0xdd, 0xdd, 0 },    /* 241      gray 221  */                                \
    { 0xe3, 0xe3, 0xe3, 0 },    /* 242      gray 227  */                                \
    { 0xea, 0xea, 0xea, 0 },    /* 243      gray 234  */                                \
    { 0xf1, 0xf1, 0xf1, 0 },    /* 244      gray 241  */                                \
    { 0xf8, 0xf8, 0xf8, 0 },    /* 245      gray 248  */                                \
    { 0xff, 0xfb, 0xf0, 0 },    /* 246 Sys Reserved  */                                 \
    { 0xa0, 0xa0, 0xa4, 0 },    /* 247 Sys Reserved  */                                 \
    { 0x80, 0x80, 0x80, 0 },    /* 248 Sys Lt Gray  gray 128  */                        \
    { 0xff, 0x00, 0x00, 0 },    /* 249 Sys Red  */                                      \
    { 0x00, 0xff, 0x00, 0 },    /* 250 Sys Green  */                                    \
    { 0xff, 0xff, 0x00, 0 },    /* 251 Sys Yellow  */                                   \
    { 0x00, 0x00, 0xff, 0 },    /* 252 Sys Blue  */                                     \
    { 0xff, 0x00, 0xff, 0 },    /* 253 Sys Violet  */                                   \
    { 0x00, 0xff, 0xff, 0 },    /* 254 Sys Cyan  */                                     \
    { 0xff, 0xff, 0xff, 0 }     /* 255 Sys White     gray 255  */                       \
  }
#endif
};

static LRESULT CALLBACK _DesktopWndProc( HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam );
BOOL RegisterWin32WinClass( HINSTANCE );

const char classWIN32DESKTOP[] = "WIN32DESKTOP";
//extern LPBYTE __lpwDisplayFrameBuf;
RECT rectPower = { 13, 271, 13 + 16, 271 + 16 };
CRITICAL_SECTION csDisplay;

//显示面
static HDC hFrameDC;   //显示DC
static HBITMAP hbmpFrame;	//显示位图句柄
static LPBYTE lpFrameBuf; //显示位图显示面（内存地址）
//

static LRESULT DoPaint( HWND hWnd, HDC hdc, const RECT * lprcClip );
extern LRESULT WINAPI Msg_Send( HWND, UINT, WPARAM, LPARAM );

BOOL RegisterWin32Class( HINSTANCE hInst )
{
    WNDCLASS wc;
	//extern DWORD __imp__LoadIcon;

    wc.style = CS_PARENTDC ;//| CS_DBLCLKS;
    wc.lpfnWndProc = _DesktopWndProc;
    wc.hInstance = hInst;
    wc.hIcon = LoadIcon( hInst, MAKEINTRESOURCE( IDI_ICON ) );
	wc.cbClsExtra = 0;//__imp__LoadIcon;
    wc.cbWndExtra = 0;

    wc.hCursor = LoadCursor(NULL,IDC_ARROW);
    wc.hbrBackground = GetStockObject( WHITE_BRUSH );//GetStockObject( LTGRAY_BRUSH );
    wc.lpszMenuName = 0;
    wc.lpszClassName = classWIN32DESKTOP;
	
    return RegisterClass( &wc );
}

extern void InitWin32DebugWindow( hInstance );
//#define WIN_DESKTOP_WIDTH 322
//#define WIN_DESKTOP_HEIGHT 515
//#define KINGMOS_STARTX  41
//#define KINGMOS_STARTY  71

//#define SAVE_SKIP
#ifdef SAVE_SKIP
void SaveDeskImageToC( HBITMAP hBitmap )
{

	LPWORD lpwData;
	BITMAPINFO bitMapInfo;
	HDC hdc = GetDC( NULL );
	if( hBitmap )
	{
		memset( &bitMapInfo, 0, sizeof(bitMapInfo) );
		bitMapInfo.bmiHeader.biSize = sizeof(bitMapInfo.bmiHeader);

		if( GetDIBits( hdc, hBitmap, 0, 0, NULL, &bitMapInfo, DIB_RGB_COLORS ) )
		{
			LPWORD lpwData;
			struct MY_BITMAPINFO mybi;
			int nScanBytes;

			mybi = myBitmapInfo;
			mybi.bmiHeader.biHeight = -bitMapInfo.bmiHeader.biHeight;
			mybi.bmiHeader.biWidth = bitMapInfo.bmiHeader.biWidth;
			mybi.bmiHeader.biClrImportant = 3;
			nScanBytes = mybi.bmiHeader.biWidth * 2;
			nScanBytes = (nScanBytes + 3) & (~3);

			lpwData = malloc( bitMapInfo.bmiHeader.biHeight * nScanBytes );
			if( lpwData )
			{				
			    if( GetDIBits( hdc, hBitmap, 0, bitMapInfo.bmiHeader.biHeight, lpwData, &mybi, DIB_RGB_COLORS ) )
				{
					int h = bitMapInfo.bmiHeader.biHeight;
					int w = mybi.bmiHeader.biWidth;
					int i, j;
					HANDLE hFile = CreateFile( "skip.c", GENERIC_WRITE|GENERIC_READ, 0, NULL, CREATE_ALWAYS, 0, NULL );
					if( hFile != INVALID_HANDLE_VALUE )
					{
					    DWORD dwWrite;
						LPWORD lpwLine = lpwData;
					    char buf[32];

						static const char szFileHeader[] = "const unsigned short wSkipImage[] = {\r\n";
						static const char szFileLineHeader[] = "    ";
						
						sprintf( buf, "const int nSkipHeight = %d;\r\n", h );
						WriteFile( hFile, buf,  strlen( buf ), &dwWrite, NULL );
						sprintf( buf, "const int nSkipWidth = %d;\r\n", w );
						WriteFile( hFile, buf,  strlen( buf ), &dwWrite, NULL );
						
						WriteFile( hFile, szFileHeader, sizeof( szFileHeader ) - 1, &dwWrite, NULL );
						for( i = 0; i < h ; i++ )
						{
							LPWORD lpw = lpwLine;
						    WriteFile( hFile, szFileLineHeader, 4, &dwWrite, NULL );
							for( j = 0; j < w; j++ )
							{
								WORD color = *lpw;
								WORD b = color & 0x001f;
								WORD g = color & 0x03e0;
								WORD r = color & 0x7c00;

								color = (r << 1) | ( g << 1 ) | b;
								//color = color

								sprintf( buf, "0x%04x,", color );
								lpw++;
							    WriteFile( hFile, buf, 7, &dwWrite, NULL ); 
							}
							// line tail
							WriteFile( hFile, "\r\n", 2, &dwWrite, NULL );
							lpwLine = (LPWORD)( (LPBYTE)lpwLine + nScanBytes );
						}
						WriteFile( hFile, "};\r\n", 3, &dwWrite, NULL );
						CloseHandle( hFile );
					}
				}
			}
			free( lpwData );
		}
	}
	ReleaseDC( NULL, hdc );

}
#endif

BOOL InitialEmlDesktop( HINSTANCE hInstance )
{
	int cx, cy;
	
	//InitWin32DebugWindow( hInstance );
    hDeskTopBitmap = LoadBitmap( hInstance, MAKEINTRESOURCE( IDB_DESKTOP ) );
#ifdef SAVE_SKIP
	SaveDeskImageToC( hDeskTopBitmap );
#endif
    InitializeCriticalSection( &csDisplay );
    cx = GetSystemMetrics( SM_CXDLGFRAME ) * 2 + iDeskTopWidth;
	cy = GetSystemMetrics( SM_CYDLGFRAME ) * 2 + GetSystemMetrics( SM_CYCAPTION ) + iDeskTopHeight;

	// Init Palette;
	#ifndef COLOR_16BPP
	// tranlate PALETTEENTRY format to RGBQUAD format
	//{
	//	BYTE temp;
	//	RGBQUAD * lprgb = myBitmapInfo.bmiColors;
		//RGBQUAD          bmiColors[PALETTE_SIZE];
	//	for( i = 0; i < PALETTE_SIZE; i++ )
	//	{
	//		temp = lprgb->rgbBlue;
	//		lprgb->rgbBlue = lprgb->rgbRed;
	//		lprgb->rgbRed = temp;
	//		lprgb++;
	//	}
	//}
    #endif   //COLOR_16BPP
    
	
	hwndDeskTop = CreateWindow( 
		          classWIN32DESKTOP, 
				  "Kingmos Development Platform for Win2000",
				  WS_POPUP|WS_VISIBLE,//|WS_CAPTION|WS_SYSMENU,
		          0, 0, iDeskTopWidth, iDeskTopHeight,
				  0,
				  0,
				  hInstance,
				  0 );
	SetWindowPos( hwndDebugWnd, 0, cx + 10, 0, 0, 0, SWP_NOZORDER | SWP_NOSIZE );
	ShowWindow( hwndDebugWnd, SW_SHOW );
	SendMessage( hwndDebugWnd, WM_OUTDEBUGTEXTLINE, 0, (LPARAM)"Hello Debug.\n" );
	return (hwndDeskTop != 0); 

}

BOOL InitWin32Eml( HINSTANCE hInstance )
{
	if( RegisterWin32Class( hInstance ) == FALSE )
		return FALSE;
    if( InitialEmlDesktop( hInstance ) == FALSE )
		return FALSE;
	return TRUE;
}

static void DoFlushWindow( void )
{
    extern RECT rcDirty;
	RECT rcPaint;
    //HDC hdc;

    EnterCriticalSection(&csDisplay);
	rcPaint = rcDirty;
	rcDirty.left = rcDirty.top = rcDirty.right = rcDirty.bottom = 0;
	LeaveCriticalSection(&csDisplay);

	if( !IsRectEmpty( &rcPaint ) )
    {	
		static HDC hdc = NULL;
		if( hdc == 0 )
            hdc = GetDC(hwndDeskTop);
		if( hdc )
            DoPaint( hwndDeskTop, hdc, &rcPaint );
        //ReleaseDC( hwndDeskTop, hdc );        
    }		
}

#define FLUSH_PERIOD 20
VOID CALLBACK TimerProc(HWND hwnd, UINT uMsg, UINT idEvent, DWORD dwTime )
{
    DoFlushWindow();
}

int fInDrag = 0;
POINT ptDragStart;
RECT rectDrag;



static BOOL HandleOptionKey( HWND hWnd, int x, int y, UINT uiMsg )
{
	extern void CPU_SetIRQEvent( MSG * lpmsg );
	int i;	
	MSG msg;
	OPTIONKEY * lpok = rcOptionKey;

	for( i = 0; i < sizeof( rcOptionKey ) / sizeof(OPTIONKEY); i++, lpok++ )
	{		
		if( uiMsg >= WM_MOUSEFIRST &&
			uiMsg <= WM_MOUSELAST )
		{
			POINT pt = { x, y };
			if( PtInRect( &lpok->rc, pt ) )
			{
				msg.hwnd = hWnd;
				if( uiMsg == WM_LBUTTONDOWN )
				{
					msg.message = WM_KEYDOWN;
					msg.wParam = lpok->bVirtualKey;
					msg.lParam = lpok->bScanCode;
					CPU_SetIRQEvent( &msg );
					lpok->bDown = TRUE;
					SetCapture( hWnd );
					SetTimer( hWnd, ID_OPTION_KEY_DOWN, 250, NULL );
				}
				else if( uiMsg == WM_LBUTTONUP )
				{
					if( lpok->bDown )
					{
						msg.message = WM_KEYUP;
						lpok->bDown = FALSE;
						msg.wParam = lpok->bVirtualKey;
						msg.lParam = lpok->bScanCode;
						CPU_SetIRQEvent( &msg );
						ReleaseCapture();
						KillTimer( hWnd, ID_OPTION_KEY_DOWN );
					}
				}
				return TRUE;
			}
			else if( lpok->bDown )
			{  
				// 鼠标不在 lpok->rc 但 lpok已经被按下，释放 lpok
				msg.hwnd = hWnd;
				msg.message = WM_KEYUP;
				msg.wParam = lpok->bVirtualKey;
				msg.lParam = lpok->bScanCode;
				CPU_SetIRQEvent( &msg );
				lpok->bDown = FALSE;
				ReleaseCapture();
				KillTimer( hWnd, 12345 );
				return TRUE;
			}
		}
		else if( uiMsg == WM_TIMER && lpok->bDown )
		{
			msg.hwnd = hWnd;
			msg.message = WM_KEYDOWN;
			msg.wParam = lpok->bVirtualKey;
			msg.lParam = lpok->bScanCode;
			CPU_SetIRQEvent( &msg );
			return TRUE;
		}
	}
	return FALSE;
}


static LRESULT DoLButtonDown( HWND hWnd, int x,  int y )
{
	POINT pt;
	RECT rect;

	if( HandleOptionKey( hWnd, x, y, WM_LBUTTONDOWN ) == FALSE )
	{
		pt.x = x;
		pt.y = y;
		rect.left = iDisplayOffsetX;
		rect.top = iDisplayOffsetY;
		rect.right = iDisplayOffsetX + iDisplayWidth;
		rect.bottom = iDisplayOffsetY + iDisplayHeight;
		
		if( !PtInRect( &rect, pt ) )
		{
			fInDrag = 1;
			
			ClientToScreen(hWnd,&pt); 
			ptDragStart = pt;
			SetCapture( hWnd );
			GetWindowRect( hWnd, &rectDrag );
		}
	}
	return 0;
}


static LRESULT DoLButtonUp( HWND hWnd, int x,  int y )
{
	if( HandleOptionKey( hWnd, x, y, WM_LBUTTONUP ) == FALSE )
	{
		if( fInDrag )
		{
			POINT pt;
			pt.x= x;
			pt.y=y;
			ReleaseCapture();
			fInDrag = 0;
			if( PtInRect( &rectPower, pt ) )
			{
				//DestroyWindow( hWnd );
			}
		}
	}
	return 0;
}


static LRESULT DoMouseMove( HWND hWnd, int x,  int y, int iButtonDown )
{
	if( fInDrag )
	{
        RECT rect = rectDrag;
		POINT pt;

		pt.x = x; pt.y = y;
		ClientToScreen(hWnd,&pt); 
        
		OffsetRect( &rect, pt.x-ptDragStart.x, pt.y-ptDragStart.y );
		SetWindowPos(hWnd, 0, rect.left, rect.top, 0, 0, SWP_NOZORDER | SWP_NOSIZE );
	}
	else
	{
//		if( iButtonDown )
	    HandleOptionKey( hWnd, x, y, WM_MOUSEMOVE );
	}
	return 0;
}


static LRESULT DoEraseBkgnd( HWND hWnd, HDC hdc )
{
	HDC hMemDC = CreateCompatibleDC(hdc);
	HGDIOBJ hSaveBmp;

	hSaveBmp = SelectObject( hMemDC, hDeskTopBitmap );

    BitBlt( hdc, 0, 0, iDeskTopWidth, iDeskTopHeight, hMemDC, 0, 0, SRCCOPY );
	SelectObject( hMemDC, hSaveBmp );
	DeleteDC( hMemDC );
	return 1;
}
/*
static LRESULT ___DoEraseBkgnd( HWND hWnd, HDC hdc )
{
	HBRUSH hBrush, hb;
//	HPEN hPen;
	int i, l, t, r, b;
	int cx, cy;
//    PAINTSTRUCT ps;    
    RECT rect, rcDisp;
    HDC hMemDC; 
    HBITMAP hBitmap;

    GetClientRect( hWnd, &rect );
    //rect.left = 0;//i;
    //rect.top = 0;//iRGBNum + cy + iRGBNum - i;
    //rect.right = rect.right;//iRGBNum + cx + iRGBNum - i;
    //rect.bottom = rect.bottom;//iRGBNum + cy + iRGBNum - i + WORK_PAD_HEIGHT;
	hb = CreateSolidBrush( rgbs[iRGBNum / 2] );	
    FillRect( hdc, &rect, hb );
    DeleteObject( hb );

	hb = CreateSolidBrush( CL_BKLIGHT );	
    rcDisp = rect;
    rcDisp.left = iDisplayOffsetX;
    rcDisp.top = iDisplayOffsetY;
    rcDisp.right = iDisplayOffsetX + iDisplayWidth;
    rcDisp.bottom = iDisplayOffsetY + iDisplayHeight;
    FillRect( hdc, &rcDisp, hb );
    DeleteObject( hb );

    hBrush = SelectObject( hdc, GetStockObject( NULL_BRUSH ) );


	cx = rect.right;
	cy = rect.bottom;
	for( i = 0; i < iRGBNum / 2; i++ )
	{
		HPEN h = CreatePen( PS_SOLID, 0, rgbs[i] );
        h = SelectObject( hdc, h );
        Rectangle( hdc, 
                   i,
                   i,
                   cx-i,//iRGBNum + cx + iRGBNum - i,
                   cy-i );//iRGBNum + cy + iRGBNum - i + WORK_PAD_HEIGHT );
		h = SelectObject( hdc, h );
        DeleteObject( h );        
	}

	l = iDisplayOffsetX - iRGBNum;
    t = iDisplayOffsetY - iRGBNum;
    r = iDisplayOffsetX + iDisplayWidth + iRGBNum;
    b = iDisplayOffsetY + iDisplayHeight + iRGBNum;
    for( ; i < iRGBNum; i++ )
	{
		HPEN h = CreatePen( PS_SOLID, 0, rgbs[i] );
        h = SelectObject( hdc, h );
        Rectangle( hdc, 
                   l+i,
                   t+i,
                   r - i,//iRGBNum + cx + iRGBNum - i,
                   b - i );//iRGBNum + cy + iRGBNum - i );
		h = SelectObject( hdc, h );
        DeleteObject( h );
	}
    SelectObject( hdc, hBrush );


    hBitmap = hLogoBitmap;
	if( hBitmap )
	{
		hMemDC = CreateCompatibleDC(hdc);
		hBitmap = SelectObject( hMemDC, hBitmap );
	    l = iDisplayOffsetX + (iDisplayWidth - 155) / 2;
        t = iDisplayOffsetY + (iDisplayHeight- 104) / 2;

	    SetBkColor( hdc, CL_BKLIGHT );
        BitBlt( hdc, l, t, 155, 104, hMemDC, 0, 0, SRCCOPY );
		hBitmap = SelectObject( hMemDC, hBitmap );
		DeleteDC( hMemDC );
		return 1;
	}
	return 0; 
}
*/

//得到显示面
LPBYTE GetFrameBuf( void )
{
	//hbmpFrame = CreateDIBSection( NULL, &myBitmapInfo, DIB_RGB_COLORS, &lpFrameBuf, NULL, 0 );
	return lpFrameBuf;
}

static LRESULT DoPaint( HWND hWnd, HDC hdc, const RECT * lprcClip )
{
//    HBITMAP hBitmap;

    if( hFrameDC ) //__lpwDisplayFrameBuf )
    {
        //hBitmap = CreateDIBitmap(hdc, &myBitmapInfo.bmiHeader, CBM_INIT, __lpwDisplayFrameBuf, (BITMAPINFO*)&myBitmapInfo, DIB_RGB_COLORS );
		//hBitmap = SelectObject( hFrameDC, hBitmap );
        SetBkColor( hdc, CL_BKLIGHT );

        if( lprcClip )
        {
            BitBlt( hdc, iDisplayOffsetX + lprcClip->left, iDisplayOffsetY + lprcClip->top, lprcClip->right - lprcClip->left, lprcClip->bottom - lprcClip->top, hFrameDC, lprcClip->left, lprcClip->top, SRCCOPY );
        }
        else        
		    BitBlt( hdc, iDisplayOffsetX, iDisplayOffsetY, iDisplayWidth, iDisplayHeight, hFrameDC, 0, 0, SRCCOPY );

		//hBitmap = SelectObject( hFrameDC, hBitmap );
		//DeleteDC( hMemDC );
		//DeleteObject( hBitmap );
	}
    return 0;
}

static LRESULT DoCreate( HWND hWnd )
{
    HDC hdc;
//	hFrameDC;   //显示DC
//static HBITMAP hbmpFrame;	//显示位图句柄
//static LPBYTE lpFrameBuf; //显示位图显示面（内存地址）

	hdc = GetDC( hWnd );
	
	//初始化显示面
	hFrameDC = CreateCompatibleDC(hdc);
	hbmpFrame = CreateDIBSection( NULL, (BITMAPINFO*)&myBitmapInfo, DIB_RGB_COLORS, &lpFrameBuf, NULL, 0 );
	SelectObject( hFrameDC, hbmpFrame );
	{	//初始化开机LOGO
		HDC hMemDC = CreateCompatibleDC(hdc);
		HGDIOBJ hSaveBmp;
		
		hSaveBmp = SelectObject( hMemDC, hDeskTopBitmap );
		
		//BitBlt( hdc, 0, 0, 800, 600, hMemDC, 0, 0, SRCCOPY );
		//BitBlt( hFrameDC, iDisplayOffsetX, iDisplayOffsetY, iDisplayWidth, iDisplayHeight, hFrameDC, 0, 0, SRCCOPY );
		BitBlt( hFrameDC, 0, 0, iDisplayWidth, iDisplayHeight, hMemDC, iDisplayOffsetX, iDisplayOffsetY, SRCCOPY );

		SelectObject( hMemDC, hSaveBmp );
		DeleteDC( hMemDC );
		
		
	}
	//
	
	ReleaseDC( hWnd, hdc );
	SetTimer( hWnd, 1234, FLUSH_PERIOD, TimerProc );
	return 0;
}

LRESULT CALLBACK _DesktopWndProc( HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam )
{
	extern BOOL IsESOFTExit( void );

    switch( msg )
    {
	case WM_LBUTTONDOWN:
		return DoLButtonDown( hWnd, (short)LOWORD(lParam), (short)HIWORD(lParam) );
	case WM_LBUTTONUP:
		return DoLButtonUp( hWnd, (short)LOWORD(lParam), (short)HIWORD(lParam) );
	case WM_MOUSEMOVE:
		return DoMouseMove( hWnd, (short)LOWORD(lParam), (short)HIWORD(lParam), wParam & MK_LBUTTON );
	case WM_CREATE:       
		return DoCreate( hWnd );
	case WM_PAINT:
        {
			PAINTSTRUCT ps;
		    HDC hdc;

			hdc = BeginPaint( hWnd, &ps );
			DoPaint( hWnd, hdc, 0 );
			EndPaint( hWnd, &ps );
        }
        return 0;
	case WM_ERASEBKGND:
        return DoEraseBkgnd( hWnd, (HDC)wParam );
	case WM_TIMER:
		return HandleOptionKey( hWnd, -1, -1, WM_TIMER );
	case WM_CLOSE:
		if( IsESOFTExit() )
			DestroyWindow( hWnd );
		else
		{
		    Msg_Send( HWND_BROADCAST, WM_CLOSE, 0, 0 );
		}
		return 0;
	case WM_DESTROY:
		DestroyWindow( hwndDebugWnd );
		PostQuitMessage(0);		
		return 0;
    }
    return DefWindowProc( hWnd, msg, wParam, lParam );
}

void SetEmlCapture( void )
{
	if( hwndDeskTop )
		SetCapture( hwndDeskTop );
}

void ReleaseEmlCapture( void )
{
	if( hwndDeskTop )
		ReleaseCapture();
}
